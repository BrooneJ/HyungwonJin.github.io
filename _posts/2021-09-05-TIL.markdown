---
layout: post
title: "210905-TIL(multer, React)"
subtitle: "TIL-210905"
categories: til
tags: til
comments: false
---


## ğŸŒŸ multerë¡œ ì˜¬ë¦¬ê³  ë°±ì—”ë“œì—ì„œ ë³¼ ìˆ˜ ìˆê²Œ í•˜ëŠ” ë°©ë²•
---
![1-1](/assets/img/web/2021-09-05/1-1.png)          
í˜„ì¬ëŠ” ìœ„ì™€ ê°™ì´ ë°±ì—”ë“œì˜ uploads íŒŒì¼ì— ì˜¬ë¦° íŒŒì¼ì„ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì½ì–´ì˜¤ì§€ ëª»í•˜ê³  ìˆë‹¤.       
ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.     
<br/>

ğŸ—‚ front/component/PostForm.js      
```javascript
const PostForm = () => {
return (
<Form style={{ margin: '10px 0 20px' }} encType="multipart/form-data" onFinish={onSubmit}>
    <div>
        {imagePaths.map((v, i) => (
                    <div key={v} style={{ display: "inline-block " }}>
                        <img src={`http://localhost:3065/${v}`} style={{ width: '200px ' }} alt={v} />
                        // imgì—ì„œ srcë¥¼ ê°€ì ¸ì˜¬ë•Œ ë°±ì—”ë“œ ì£¼ì†Œë¡œ ì§€ì •í•´ì¤€ë‹¤. 
                        // ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ 'localhost:3000/íŒŒì¼ëª…'ìœ¼ë¡œ ì£¼ì†Œê°€ ì¡í˜€ì„œ ì½ì–´ì˜¤ì§€ ëª»í•œë‹¤.       
                        ...
                    </div>
                ))}
    </div>
```

ì´ëŸ¬í•œ í˜„ìƒì€ ê²Œì‹œë¬¼ì„ ì˜¬ë¦° í›„ì—ë„ ì¼ì–´ë‚˜ë¯€ë¡œ postcard ë¶€ë¶„ë„ ë˜‘ê°™ì´ ì²˜ë¦¬í•´ ì£¼ì–´ì•¼í•œë‹¤.    
ì¦‰, ë°±ì—”ë“œì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ì€ ì „ë¶€ 'ë°±ì—”ë“œ ì£¼ì†Œ'ë¡œ ë³€ê²½í•´ì£¼ì–´ì•¼í•œë‹¤.      

ğŸ—‚ front/component/PostCard.js
```javascript
const PostImages = ({ images }) => {
if (images.length === 1) {
        return (
            <>
->              <img role="presentation" src={`http://localhost:3065/${images[0].src}`} alt={images[0].src} onClick={onZoom} />
                {showImageZoom && <ImageZoom images={images} onClose={onClose} />}
            </>
        )
    }
    if (images.length === 2) {
        return (
            <>
->              <img role="presentation" style={{ width: "50%", display: "inline-block" }} src={`http://localhost:3065/${images[0].src}`} alt={images[0].src} onClick={onZoom} />
->              <img role="presentation" style={{ width: "50%", display: "inline-block" }} src={`http://localhost:3065/${images[1].src}`} alt={images[1].src} onClick={onZoom} />
                {showImageZoom && <ImageZoom images={images} onClose={onClose} />}
            </>
        )
    }
    return (
        <>
            <div>
->              <img role="presentation" width="50%" src={`http://localhost:3065/${images[0].src}`} alt={images[0].src} onClick={onZoom} />
</div>
</>
)
}
```
![1-1](/assets/img/web/2021-09-05/1-2.png)          
![1-1](/assets/img/web/2021-09-05/1-3.png)          
ë°±ì—”ë“œ ì£¼ì†Œë¡œ ë°”ê¿”ì£¼ë©´ ê³ ì–‘ì´ ì‚¬ì§„ì„ ë°›ì•„ì˜¬ ìˆ˜ ìˆê²Œ ëœë‹¤.

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ ì‚¬ì§„ì„ ì—¬ëŸ¬ê°œ ì˜¬ë¦¬ëŠ” ë°©ë²•
---
multerë¥¼ ì‚¬ìš©í•˜ë©´ ì‚¬ì§„ì„ í•œê°œëŠ” ë¬¼ë¡  ì—¬ëŸ¬ê°œì˜ ì‚¬ì§„ì„ ë™ì‹œì— ì˜¬ë¦´ ìˆ˜ ìˆë‹¤.       

ğŸ—‚ back/app.js      
```javascript
const path = require('path');

app.use('/', express.static(path.join(__dirname, 'uploads')))
// ê²½ë¡œë¥¼ ê°ì¶œ ìˆ˜ ìˆë‹¤ëŠ” ì´ì ì´ ìˆìŒ.
```

ğŸ—‚ back/routes/post.js
```javascript
router.post('/', isLoggedIn, upload.none(), async (req, res, next) => {
    try {
        const post = await Post.create({
            content: req.body.content,
            UserId: req.user.id,
        })
        if (req.body.image) {
            if (Array.isArray(req.body.image)) { // ì´ì§€ë¯¸ë¥¼ ì—¬ëŸ¬ ê°œ ì˜¬ë¦¬ë©´ image: [íŒŒì¼ëª…1.png, íŒŒì¼ëª…2.png]
                const images = await Promise.all(req.body.image.map((image) => Image.create({ src: image })));
                await post.addImages(images);
            } else { // ì´ë¯¸ì§€ë¥¼ í•˜ë‚˜ë§Œ ì˜¬ë¦¬ë©´ image: íŒŒì¼ëª….png
                const image = await Image.create({ src: req.body.image });
                await post.addImages(image);
            }
        }
    }
}
```        

ğŸ—‚ front/component/PostForm.js      
```javascript
const onSubmit = useCallback(() => {
    if (!text || !text.trim()) {
        return alert('ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ì„¸ìš”.');
    }
    const formData = new FormData();
    imagePaths.forEach((p) => {
        formData.append('image', p);
    })
    formData.append('content', text);
    return dispatch({
        type: ADD_POST_REQUEST,
        data: formData,
    });
}, [text, imagePaths]);
```
ì œì¶œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ textê°€ ìˆëŠ” ì§€ í™•ì¸ë¶€í„° í•˜ê³ , imagePaths ì†ì— ìˆëŠ” imageë“¤ì„ formDataì— ë„£ê³  textë„ ë„£ëŠ”ë‹¤.      
ê·¸ë¦¬ê³  ì´ dataì— ë„£ì–´ì„œ ë³´ë‚¸ë‹¤.     

ê·¸ë¦¬ê³  ë‚˜ë©´ reduxì—ì„œ ë°›ê³  imagePathsë¥¼ ì´ˆê¸°í™” í•˜ê³  ì‘ì—…ì„ ëë‚¸ë‹¤.    

ğŸ—‚ front/reducer/post.js        
```javascript
case ADD_POST_SUCCESS:
    draft.addPostLoading = false;
    draft.addPostDone = true;
    draft.mainPosts.unshift(action.data);
    draft.imagePaths = [];
    break;
```            

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ ì‚¬ì§„ì„ ì˜¬ë¦¬ë‹¤ê°€ ë„ì¤‘ì— ì œê±° ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì²˜ë¦¬í•˜ê¸°
---
ì‚¬ì§„ì„ ì˜¬ë¦¬ë‹¤ê°€ ì˜ëª» ì§€ì •í–ˆê±°ë‚˜ ë§ˆìŒì´ ë°”ë€Œì–´ì„œ ì§€ìš°ê³  ì‹¶ì–´ì§ˆ ë•Œê°€ ìˆì„ ê²ƒì´ë‹¤.     
ê·¸ëŸ´ ë• ì œê±° ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ì‚¬ì§„ì„ ì—†ì•¨ í•„ìš”ê°€ ìˆë‹¤.     

ğŸ—‚ front/component/PostForm.js      
```javascript
const onRemoveImage = useCallback((index) => () => {
    dispatch({
        type: REMOVE_IMAGE,
        data: index,
    })
})

<div>
    <Button onClick={onRemoveImage(i)}>ì œê±°</Button>
</div>
```    
ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì•¡ì…˜ì´ ì‹¤í–‰ë¨        

ğŸ—‚ front/reducer/post.js        
```javascript
const reducer = (state = initialState, action) => {
    return produce(state, (draft) => { // stateê°€ ì´ë¦„ì´ draftë¡œ ë°”ë€œ
        switch (action.type) {
            case REMOVE_IMAGE:
                draft.imagePaths = draft.imagePaths.filter((v, i) => i !== action.data);
                break;
```                
imagePaths ì†ì— ìˆëŠ” ì „ë‹¬ ë°›ì€ indexì˜ ì‚¬ì§„ì„ ì‚­ì œí•¨        
      

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ hashtag ì ìš©í•˜ëŠ” ë°©ë²•
---

ğŸ—‚ back/routes/post.js      
```javascript
router.post('/', isLoggedIn, upload.none(), async (req, res, next) => {
    try {
        const hashtags = req.body.content.match(/#[^\s#]+/g);
        // content ë‚´ì—ì„œ ì •ê·œí™”ë¥¼ í†µí•´ì„œ #ê°€ ë“¤ì–´ê°„ ë‹¨ì–´ë¥¼ ì°¾ì•„ë‚¸ë‹¤.
        ...
        if (hashtags) {
                const result = await Promise.all(hashtags.map((tag) => Hashtag.findOrCreate({ // ì´ë¯¸ ë“±ë¡ëœ hashtagë©´ ìƒì„±í•˜ì§€ ì•ŠìŒ
                    where: { name: tag.slice(1).toLowerCase() }, // db ë‚´ì—ì„œëŠ” ëŒ€ì†Œë¬¸ì ê´€ê³„ ì—†ì–´ ì†Œë¬¸ìë¡œ ë§Œë“¤ì–´ì¤Œ
                }))); // [[ë…¸ë“œ, true], [ë¦¬ì•¡íŠ¸,true ]]
                await post.addHashtags(result.map((v) => v[0]));
            }
        }
}
```


ğŸ—‚ front/component/PostCardContent.js       
```javascript
const PostCardContent = ({ postData }) => {
    return (
        <div>
            {postData.split(/(#[^\s#]+)/g).map((v, i) => {
                if (v.match(/(#[^\s#]+)/)) {
                    return <Link href={`/hashtag/${v.slice(1)}`} key={i}><a>{v}</a></Link>
                    // /hashtag/${v.slice(1)}ëŠ” ê¸€ì ì²«ë²ˆì§¸ì¸ #ì„ ë–¼ëŠ” ê¸°ëŠ¥
                }
                return v;
            })}
        </div>
    )
}
```
![1-1](/assets/img/web/2021-09-05/1-4.png)          
ìœ„ì™€ ê°™ì´ hashtagê°€ ìƒì„±ë˜ê³        
<br/> 

![1-1](/assets/img/web/2021-09-05/1-5.png)        
Hashtag í…Œì´ë¸”ì— 'ë…¸ë“œ', 'ìµìŠ¤í”„ë ˆìŠ¤'ë¼ëŠ” ë‹¨ì–´ê°€ 1,2 ë²ˆìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆê³         
![1-1](/assets/img/web/2021-09-05/1-6.png)          
PostHashtagì— ë…¸ë“œ, ìµìŠ¤í”„ë ˆìŠ¤ë¼ëŠ” ë‹¨ì–´ê°€ ê²Œì‹œê¸€ PostId 5,6ë²ˆê³¼ ë§¤ì¹­ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.     

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ lastIdë¥¼ ì‚¬ìš©í•œ ë¬´í•œ ìŠ¤í¬ë¡¤
---
ğŸ—‚ pages/index.js
```javascript
 if (hasMorePost && !loadPostLoading) {
    const lastId = mainPosts[mainPosts.length - 1]?.id;
    dispatch({
            type: LOAD_POST_REQUEST,
            lastId,
        });
 }
```              
hasMorePostê°€ trueì´ê³  í˜„ì¬ loadPostLoading ìƒíƒœê°€ ì•„ë‹ˆë©´ lastIdë¥¼ ì°¾ëŠ”ë° lastIdëŠ” mainPostsì˜ ê°€ì¥ ë§ˆì§€ë§‰ idì´ë‹¤.      
ì´ë¥¼ ì°¾ì•„ì„œ ì•¡ì…˜ì„ í†µí•´ì„œ reduxë¡œ ë³´ë‚¸ë‹¤.       

ğŸ—‚ sagas/post.js           
```javascript
function loadPostAPI(lastId) { // ì œë„¤ë ˆì´í„° ì•„ë‹˜
    return axios.get(`/posts?lastId=${lastId}` || 0);
    // í˜¹ì‹œ ê²Œì‹œë¬¼ì´ ì—†ìœ¼ë©´ undefineì¼ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ || 0ì„ í•´ì¤Œ
}
function* loadPost(action) {
    try {
        const result = yield call(loadPostAPI, action.lastId);
    }
}
```
loadPostëŠ” ì•¡ì…˜ìœ¼ë¡œë¶€í„° ë°›ì€ lastIdë¥¼ APIë¡œ ë³´ë‚´ê³  getìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ê¸° ë•Œë¬¸ì— ë‘ë²ˆì¨° ì¸ìì— dataë¥¼ ë‹´ì„ ìˆ˜ ì—†ë‹¤.     
ì™œëƒí•˜ë©´ getì—ì„œ ë‘ë²ˆì§¸ ì¸ìëŠ” withCredentialsì´ ë“¤ì–´ê°ˆ ìë¦¬ì´ê¸° ë•Œë¬¸ì´ë‹¤. ë”°ë¼ì„œ queryë¡œ ì²˜ë¦¬í•œë‹¤.     

ğŸ—‚ front/reducer/post.js
```javascript
case LOAD_POST_SUCCESS:
    draft.loadPostLoading = false;
    draft.loadPostDone = true;
    // draft.mainPosts = action.data.concat(draft.mainPosts); // mainPostsì— ì¶”ê°€ë˜ëŠ” ê²Œì‹œë¬¼ì„ ì´ì–´ë¶™ì„
    // draft.hasMorePost = draft.mainPosts.length < 50; // ë§ë¶™ì¸ ê¸¸ì´ê°€ 50ì„ ë„˜ëŠ”ê°€?
    draft.mainPosts = draft.mainPosts.concat(action.data); // mainPostsì— ì¶”ê°€ë˜ëŠ” ê²Œì‹œë¬¼ì„ ì´ì–´ë¶™ì„
    draft.hasMorePost = action.data.length === 10; // ë§ë¶™ì¼ ê¸¸ì´ê°€ 10ì¸ê°€? ë§ìœ¼ë©´ true ë³´ë‹¤ ì‘ìœ¼ë©´ false
    break;
```
ë¶ˆëŸ¬ì˜¬ í¬ìŠ¤íŠ¸ê°€ ì•„ë«ìª½ì— ë¶™ë„ë¡ ìˆ˜ì •	    

ğŸ—‚ back/routes/posts.js        
```javascript
const { Op } = require('sequelize');
router.get('/', async (req, res, next) => {
    try {
        const where = {};
        if (parseInt(req.query.lastId, 10)) { // ì´ˆê¸° ë¡œë”©ì´ ì•„ë‹ ë•Œ
            where.id = { [Op.lt]: parseInt(req.query.lastId, 10) }
        }
        const posts = await Post.findAll({
            where,
            limit: 10,
```    
ë§Œì•½ ê²Œì‹œë¬¼ì´ í•˜ë‚˜ë„ ì—†ì„ ë•Œì˜ ìƒí™©ì„ ê°€ì •í•œ ì½”ë“œ       
ìˆë‹¤ë©´ lastIdë³´ë‹¤ ì‘ì€ ìˆ˜ë¥¼ 10ê°œ ë³´ë‚¸ë‹¤.                

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

