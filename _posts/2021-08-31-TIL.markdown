---
layout: post
title: "210831-TIL(MySQL)"
subtitle: "TIL-210831"
categories: til
tags: til
comments: false
---


# ğŸ“ ê³µë¶€í•  ê±°ë¦¬
---
CORSë€?     

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ MySQLê³¼ redux ì—°ê²°
---
ì´ì œ ì„¤ì •í•œ databaseì™€ reduxë¥¼ ì—°ê²°í•´ì£¼ì–´ì•¼í•œë‹¤.        
<br/>

userë¥¼ ë“±ë¡í•˜ëŠ” ê²ƒì„ ì˜ˆë¡œ ë“¤ì–´ë³´ì          
<br/>    

1. frontì˜ pages/signup.jsì—ì„œ íšŒì›ê°€ì… ë²„íŠ¼ì„ ëˆ„ë¥´ë©´      
    ```javascript
    const onSubmit = useCallback(() => {
        ...
        dispatch({
            type: SIGN_UP_REQUEST,
            data: { email, password, nickname },
        })
    },[password, passwordCheck, term])
    ```
    ìœ„ì˜ ì½”ë“œê°€ ì‘ë™í•˜ê²Œ ëœë‹¤.      
    <br/>

2. ë”°ë¼ì„œ actionê³¼ í•¨ê»˜ action.dataì¸ { email, password, nickname }ê°€ reduxì™€ redux-sagaë¡œ ì „ë‹¬ë˜ê³      
    ğŸ—‚ sagas/user.js
    ```javascript
    function signUpAPI(data) { // ì œë„¤ë ˆì´í„° ì•„ë‹˜
        return axios.post('http://localhost:3065/user', data);
    }

    function* signUp(action) {
        try {
            const result = yield call(signUpAPI, action.data);
            console.log(result);
            yield delay(1000);
            yield put({
                type: SIGN_UP_SUCCESS,
            })
        } catch (err) {
            yield put({
                type: SIGN_UP_FAILURE,
                error: err.response.data,
            })
        }
    }
    function* watchSignUp() {
        yield takeLatest(SIGN_UP_REQUEST, signUp);
    }
    ```
3. watchSignUpì—ì„œ actionì„ ë°›ì•„ signUp ì œë„¤ë ˆì´í„°ë¥¼ ë¶€ë¥¸ë‹¤.       
signUp ì œë„¤ë ˆì´í„°ëŠ” actionì„ ë°›ì•„ì„œ ê·¸ ì•ˆì˜ dataë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.        
ê·¸ë¦¬ê³  ê·¸ ë°ì´í„°ë¥¼ signUpAPIì— ê°€ì ¸ê°€ì„œ http://localhost:3065/userì´ë¼ëŠ” ì£¼ì†Œë¥¼ ê°€ì§„ ë°±ì—”ë“œë¡œ ì „ë‹¬í•œë‹¤.

4.  ë°±ì—”ë“œì˜ app.jsëŠ” ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆë‹¤.     
    ğŸ—‚ app.js
    ```javascript
    const express = require('express');
    const userRouter = require('./routes/user');
    const db = require('./models');
    const app = express();
    db.sequelize.sync()
        .then(() => {
            console.log('db ì—°ê²° ì„±ê³µ');
        })
        .catch(console.error);

    app.use(express.json());
    app.use(express.urlencoded({ extended: true })); // body-parser
    app.use('/user', userRouter); 
    app.listen(3065, () => {
        console.log('ì„œë²„ ì‹¤í–‰ ì¤‘')
    });
    ```
    '/user'ë¡œ ë°›ì€ dataëŠ” ë¯¸ë“¤ì›¨ì–´ì— ì˜í•´ì„œ í•´ì„ë˜ê³ (bodyë¥¼ ì½ì„ ìˆ˜ ìˆê²Œ ë¨) ./routes/userë¡œ ë³´ë‚´ì§„ë‹¤.      

5. userRouterëŠ” ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆë‹¤.     
    ğŸ—‚ routes/user.js
    ```javascript
    const express = require('express');
    const bcrypt = require('bcrypt');
    const { User } = require('../models');

    const router = express.Router();

    router.post('/', async (req, res, next) => {
        const { email, nickname, password } = req.body;
        try {
            const exUser = await User.findOne({
                where: {
                    email,
                }
            });
            if (exUser) {
                return res.status(403).send('ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ ì…ë‹ˆë‹¤.');
            }

            const hashedPassword = await bcrypt.hash(password, 10);
            await User.create({
                email,
                nickname,
                password: hashedPassword,
            });
            res.send('ok');
        } catch (error) {
            console.error(error);
            next(error);
        }
    });

    module.exports = router;
    ```
    ìœ„ ì½”ë“œì—ëŠ” ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ì„ ì²´í¬í•˜ëŠ” ê¸°ëŠ¥ê³¼ bcryptë¥¼ í†µí•´ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸í™”í•˜ëŠ” ê³¼ì •ì„ ì¶”ê°€í•´ì£¼ì—ˆë‹¤.

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸŒ‹ğŸâ›°        
<br/>

## ğŸŒŸ CORS error (No 'Access-Control-Allow-Origin')
---

ğŸš” ë¬¸ì œ ë°œê²¬        
signup í˜ì´ì§€ì—ì„œ íšŒì›ê°€ì…ì„ í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ë¥¼ ë§ˆì£¼í•˜ê²Œ ëœë‹¤.     
![1-1](/assets/img/web/2021-08-31/1-5.png)          
(OPTIONëŠ” Access-Control-Allow-Originê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê¸°ëŠ¥)
ì´ ë¬¸ì œëŠ” CORS ì—ëŸ¬ë¡œ ë¸Œë¼ìš°ì €ì¸ localhost:3000 í¬íŠ¸ì—ì„œ ë°±ì—”ë“œì¸ localhost:3065/userë¡œ ë³´ë‚¼ë•Œ í¬íŠ¸ë„˜ë²„ê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ë¸Œë¼ìš°ì €ì—ì„œ ì°¨ë‹¨í•˜ê¸° ë•Œë¬¸ì— ì¼ì–´ë‚˜ëŠ” ì—ëŸ¬ì´ë‹¤.   
ì•Œì•„ë‘ì–´ì•¼ í•  ì‚¬í•­ì€ ë¸Œë¼ìš°ì €ì—ì„œ ë°±ì—”ë“œë¡œ ê°ˆ ë•Œì—ë§Œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. ì„œë²„ì—ì„œ ì„œë²„ë¡œ ê°ˆ ë–„ëŠ” ë¬¸ì œ ë°œìƒí•˜ì§€ ì•ŠìŒ    

ğŸ” í•´ê²° ë°©ë²•    
ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë‘ê°€ì§€ ë°©ì‹ì´ ìˆë‹¤.      
ì²«ë²ˆì§¸ëŠ” proxy ë°©ì‹ì´ ìˆë‹¤. í”„ë¡ì‹œ ë°©ì‹ì€ ë¸Œë¼ìš°ì €ì™€ í”„ë¡ íŠ¸ ì„œë²„ì˜ í¬íŠ¸ë„˜ë²„ê°€ ê°™ì€ ê²ƒì„ ì´ìš©í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ë¸Œë¼ìš°ì €ì—ì„œ í”„ë¡ íŠ¸ ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚¸ í›„ í”„ë¡ íŠ¸ ì„œë²„ì—ì„œ ë°±ì—”íŠ¸ ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ë²•ì´ë‹¤.       
ë‘ë²ˆì§¸ëŠ” í—¤ë”ì— Access-Control-Allow-Originì„ ë¶™ì—¬ì„œ í•´ê²°í•˜ëŠ” ë°©ë²•ì´ ìˆë‹¤.      
```
res.setHeader("Access-Control-Allow-Origin", *);
```
ê°„ë‹¨í•˜ê²Œ í•˜ëŠ” ë°©ë²•ì€ cors ë¯¸ë“¤ì›¨ì–´ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.        
```
npm i cors
```
app.js      
```javascript
const cors = require('cors');
app.use(cors({
    origin: '*',
}));
```
cors ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ê¸° ì „
![1-1](/assets/img/web/2021-08-31/1-6.png)     
<br/>       

cors ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•œ í›„       
![1-1](/assets/img/web/2021-08-31/1-7.png)      
Access-Control-Allow-Originì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì–´ Status Code 200ì„ ë°›ì•˜ë‹¤.     

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸŒ‹ğŸâ›°        
<br/>

## ğŸŒŸ baseURL ë§Œë“¤ê¸°
---
ğŸ—‚ sagas/index.js    
```javascript
import axios from "axios";
axios.defaults.baseURL = 'http://localhost:3065';
```
ìœ„ì™€ ê°™ì´ baseURLì„ ë§Œë“¤ë©´ sagasì— ìˆëŠ” ë‹¤ë¥¸ íŒŒì¼ì—ì„œ localì£¼ì†Œë¥¼ ì…ë ¥í•˜ì§€ ì•Šê³  ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.  
ì˜ˆë¥¼ ë“¤ì–´ sagas/user.jsì—ì„œ        
```javascript
function logInAPI(data) { // (3) callì„ í•´ì„œ ë°›ì€ logInAPI(action.data)ì„
    return axios.post('http://localhost:3065/user/login', data);
}
                    |
                    V
function logInAPI(data) { 
    return axios.post('/user/login', data);
}
```
ì´ë ‡ê²Œ ë¡œì»¬ì£¼ì†Œë¥¼ ì“°ì§€ ì•Šê³  ì“¸ ìˆ˜ ìˆë‹¤.     

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸŒ‹ğŸâ›°        
<br/>

## ğŸŒŸ passport ì‚¬ìš©í•´ì„œ ë¡œê·¸ì¸ í•˜ê¸°
---
ìš°ì„  passportë¥¼ ì„¤ì¹˜í•œë‹¤.       
```
npm i passport
```
ê¸°ë³¸ ì„¸íŒ…       

app.jsì—ì„œ passportë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.
```javascript
const passportConfig = require('./passport'); // require('passport')ê°€ ì•„ë‹˜ì„ ì£¼ì˜      
passportConfig();
```

ğŸ—‚ passport/index.js       
```javascript
const passport = require('passport');
const local = require('./local');

module.exports = () => {
    passport.serializeUser(() => {

    });

    passport.deserializeUser(() => {

    });

    local();
```
ë§ˆì§€ë§‰ì— ì“´ localì€ ì•„ë˜ ì½”ë“œë¥¼ ë¶ˆëŸ¬ì˜´        

ğŸ—‚ passport/local.js  
```javascript
const passport = require('passport');
const { Strategy: LocalStrategy } = require('passport-local');
// ë¡œì»¬ ë¡œê·¸ì¸ ì „ëµ
const { User } = require('../models');

module.exports = () => {
    passport.use(new LocalStrategy({
        usernameField: 'email',
        passwordField: 'password',
    }, async (email, password, done) => {
        try {
            const user = await User.findOne({
                where: { email }
            })
            if (!user) {
                return done(null, false, { reason: 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.' })
                // doneì€ callbackì´ë‘ ë¹„ìŠ·í•œ ê²ƒ
                // done(ì„œë²„ ì—ëŸ¬, ì„±ê³µ, í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬=ë³´ë‚´ëŠ” ì¸¡ì—ì„œ ì˜ëª» ë³´ëƒˆì„ë•Œ(ex.ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì))
            }
            const result = await bcrypt.compare(password, user.password);
            if (result) {
                return done(null, user);
            }
            return done(null, false, { reason: 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.' });
        } catch (error) {
            console.error(error);
            return done(error);
        }
    }));
```
ìœ„ì™€ ê°™ì´ passport/ indexì™€ localì„ ì„¤ì •í•˜ê³         
ì•„ë˜ì™€ ê°™ì´ authenticateì„ ì„¤ì •í•˜ë©´ loginì„ ì‹¤í–‰í• ë•Œ 
LocalStrategyê°€ ì‹¤í–‰ëœë‹¤.       

ğŸ—‚ routes/user.js
```javascript
const passport = require('passport');
router.post('/login', (req, res, next) => { // ë¯¸ë“¤ì›¨ì–´ í™•ì¥
    passport.authenticate('local', (err, user, info) => {
        if (err) {
            console.error(err);
            return next(error);
        }
        if (info) {
            return res.status(401).send(info.reason);
        }
        return req.login(user, async (loginErr) => {
            if (loginErr) {
                console.error(loginErr);
                return next(loginErr);
            }
            return res.json(user);
        })
    })(req, res, next);
});
```
