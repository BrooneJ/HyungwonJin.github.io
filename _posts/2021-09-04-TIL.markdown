---
layout: post
title: "210904-TIL(multer)"
subtitle: "TIL-210904"
categories: til
tags: til
comments: false
---

## ğŸŒŸ multer 
---
íŒŒì¼ì´ë‚˜ ë¹„ë””ì˜¤ë¥¼ ì˜¬ë¦´ ë•ŒëŠ” multipartë¡œ ë°ì´í„°ê°€ ì˜¬ë¼ê°€ê¸° ë•Œë¬¸ì— ì²˜ë¦¬í•´ ì¤„ ë¯¸ë“¤ì›¨ì–´ê°€ í•„ìš”í•¨        
```
npm i multer
```

ğŸ—‚ front/components/PostForm.js     
```javascript

const onChangeImages = useCallback((e) => {
    console.log('image', e.target.files);
    const imageFormData = new FormData();
    [].forEach.call(e.target.files, (f) => {
        imageFormData.append('image', f); // ì•„ë˜ì˜ input
    });
    dispatch({
        type: UPLOAD_IMAGES_REQUEST,
        data: imageFormData,
    })
})
retrun (
    <Form style={{ margin: '10px 0 20px' }} encType="multipart/form-data" onFinish={onSubmit}>
    // ì´ ë¶€ë¶„ì—ì„œ multipartfmf í†µí•´ì„œ ë¹„ë””ì˜¤, ì‚¬ì§„ì„ ì²˜ë¦¬í•¨
        <div>
            <input type="file" name="image" multiple hidden ref={imageInput} onChange={onChangeImages} />
            // nameì„ imageë¡œ ì„¤ì •í•´ì£¼ì–´ ê° ë‹¨ê³„ì—ì„œ imageë¥¼ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
            <Button onClick={onClickImageUpload}>ì´ë¯¸ì§€ ì—…ë¡œë“œ</Button>
            <Button type="primary" style={{ float: "right" }} htmlType="submit">ì§¹ì§¹</Button>
        </div>
    <Form/>
)
```
multerëŠ” appì— ì˜¬ë ¤ì„œ ì „ì²´ë¥¼ ê³µí†µì ì¸ í¼ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆì§€ë§Œ ê°í˜ì´ì§€ ë§ˆë‹¤ ë§Œë“¤ì–´ì£¼ëŠ” ê²ƒì´ íš¨ìœ¨ì ì´ë‹¤. ì™œëƒí•˜ë©´ ì–´ë–¤ í˜ì´ì§€ì—ì„œëŠ” ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë‘ì¥ ì˜¬ë¦¬ê³  ì–´ë–¤ í˜ì´ì§€ì—ì„  í•œì¥ë§Œ ì˜¬ë¦¬ê³  ì–´ë–¤ í˜ì´ì§€ì—ì„œëŠ” í…ìŠ¤íŠ¸ë§Œ ì˜¬ë¦´ ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤.        

ğŸ—‚ back/routes/post.js      
```javascript
const multer = require('multer');
const path = require('path'); // nodeì—ì„œ ì œê³µ      

const upload = multer({
    storage: multer.diskStorage({ // í˜„ì¬ëŠ” AWSê°€ ì•„ë‹Œ ë¡œì»¬ì— ì €ì¥í•¨
        destination(req, file, done) {
            done(null, 'uploads');
        },
        filename(req, file, done) { // íŒŒì¼ëª….png
            const ext = path.extname(file.originalname); // í™•ì¥ì ì¶”ì¶œ(.png)
            const basename = path.basename(file.originalname, ext); // íŒŒì¼ëª…
            done(null, basename + new Date().getTime() + ext); // íŒŒì¼ëª…3462346.png
        },
    }),
    limits: { fileSize: 20 * 1024 * 1024 } // 20MB
})
router.post('/images', isLoggedIn, upload.array('image'), (req, res, next) => {
    console.log(req.files);
    req.json(req.files.map((v) => v.filename))
})
```

ğŸ—‚ front/reducer/post.js
```javascript
case UPLOAD_IMAGES_SUCCESS: {
    draft.imagePaths = action.data;
    draft.uploadImagesLoading = false;
    draft.uploadImagesDone = true;
    break;
}
```