---
layout: post
title: "210907-TIL(javascript, infiniteScroll)"
subtitle: "TIL-210907"
categories: til
tags: til
comments: false
---

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ ë¬´í•œ ìŠ¤í¬ë¡¤ (Infinite Scroll)
---
<img src="https://raw.githubusercontent.com/HyungwonJin/HyungwonJin.github.io/main/assets/img/web/2021-09-07/1-1.png" width="200"/>             

ì²˜ìŒì—ëŠ” ìœ„ì˜ ì‚¬ì§„ê³¼ ê°™ì´ pagenationì„ ì‚¬ìš©í•´ì„œ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ í´ë¦­í•˜ë©´ ì´ë™í•˜ê²Œ ë§Œë“¤ë ¤ê³  í–ˆì§€ë§Œ UXë¥¼ ìƒê°í•˜ë©´ infinite scroll ë°©ì‹ì´ ë” í¸í•œ ê²ƒ ê°™ì•„ì„œ infinite scrollì„ êµ¬í˜„í•˜ê²Œ ë˜ì—ˆë‹¤. (ë²„íŠ¼ í•œê°œ í•œê°œë¥¼ ëˆŒëŸ¬ê°€ë©´ì„œ ë‹¤ìŒ í˜ì´ì§€ë¡œ ë„˜ì–´ê°€ëŠ” ê²ƒë³´ë‹¤ëŠ” ìŠ¤í¬ë¡¤ì„ ë‚´ë ¤ì„œ ë‹¤ìŒ í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ë“¤ì´ëŠ” ê²ƒì´ ë” í¸í•˜ë‹¤ê³  ìƒê°í–ˆë‹¤.)       
í˜„ì¬ë¡œì„œëŠ” pagenation ë°©ì‹ìœ¼ë¡œ í•  ë•Œë³´ë‹¤ ë©”ë¦¬íŠ¸ê°€ ë” í° ê²ƒ ê°™ë‹¤.      

ì°¸ê³ : <https://developer.mozilla.org/ko/docs/Web/API/Intersection_Observer_API>     
<https://tech.lezhin.com/2017/07/13/intersectionobserver-overview>          
<https://www.imkh.dev/js-intersection-observer/>   

ìš”ì•½í•˜ë©´ ì œì¼ ë§ˆì§€ë§‰ì— detector ë¼ëŠ” divë¥¼ ë‘¬ì„œ í™”ë©´ì— detectorê°€ ë‚˜íƒ€ë‚˜ë©´ ë‹¤ìŒ í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ë“¤ì¸ë‹¤ëŠ” ê²ƒì´ë‹¤.       
ë”°ë¼ì„œ HTMLì—ì„œ     

ğŸ—‚ src/views/home.pug
```
block content
    each word in words 
        +words(word)
    else
        li not found 

    div.scroll-detecting
```
scroll-detectingì´ë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ê°€ì§„ divë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤.     
ê·¸ë¦¬ê³  ì´ scroll-detectingê°€ í™”ë©´ì— ë³´ì´ë©´ í•´ì¤„ í–‰ë™ì„ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.       
<br/>

ğŸ—‚ src/client/js/infiniteScroll.js      
```js
const loadItem = async () => {
    try {
        // ë°±ì—”ë“œì— ë‹¤ìŒ í˜ì´ì§€ë¥¼ ìš”êµ¬í•˜ëŠ” post reqë¥¼ ë³´ëƒ„
        const response = await fetch('/api/pages', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ pageCounter }),
        });
        // ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ 201 ì‘ë‹µê³¼ jsonë°ì´í„°ë¥¼ ë°›ìŒ
        if (response.status === 201) {
            const { words } = await response.json();
            if (words.length !== 0) {
                htmlMaking(words);
            }
        } else { // 201 ì‘ë‹µì´ ì•„ë‹ˆë¼ë©´ ë”ì´ìƒ ë§ˆì§€ë§‰ í˜ì´ì§€ì— ë„ë‹¬í–ˆìŒì„ ì•Œ ìˆ˜ ìˆìŒ
            hasMore = false; // ë”ì´ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ false ì²˜ë¦¬
        }
        pageCounter++;

    } catch (error) {
        console.error(error);
    }
    container.appendChild(detector); // ë§ˆì§€ë§‰ í˜ì´ì§€ì— detectorë¥¼ ì‚½ì…
}

const io = new IntersectionObserver(entries => {
    if (entries.some(entry => entry.intersectionRatio > 0)) {
        if (hasMore) {
            loadItem();
        }
    }
})
if (detector) {
    io.observe(detector)
}
```
ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ hasMoreê°€ trueì´ê³  ì—†ìœ¼ë©´ falseë¡œ ë°”ê¿” ë‹¤ìŒ í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” post requestë¥¼ í•˜ì§€ì•ŠìŒ      
<br/>

>í˜ì´ì§€ë¥¼ ë³µì¡í•˜ê²Œ ë§Œë“¤ë©´ í”„ë¡ íŠ¸ì—ì„œ ë‹¤ì‹œ ë§Œë“œëŠ” ê²ƒì€ ê·¹í•œì˜ ì‘ì—…ì´ì—ˆë‹¤...       
><https://github.com/HyungwonJin/dailyword/blob/master/src/client/js/infiniteScroll.js>
>ì•—... ì›ë˜ ì´ë ‡ê²Œ ë³µì¡í•˜ê²Œ í•´ì•¼í•˜ëŠ” ê²ƒì¸ì§€ ì¢€ ì•Œì•„ë³¼ í•„ìš”ì„±ì„ ì—„ì²­ë‚˜ê²Œ ëŠê¼ˆë‹¤... ë¦¬ì•¡íŠ¸ë¥¼ ì´ëŸ¬ì§€ ì•Šì•˜ëŠ”ë°...

>ê¼­ í•´ì¤˜ì•¼í•˜ëŠ” ê²ƒ!
>ğŸ—‚ src/client/js/main.js
>```js
>import "./infiniteScroll";
>```
>ğŸ—‚ webpack.config.js        
>```js
>module.exports = {
>    entry: {
>        infiniteScroll: BASE_JS + "infiniteScroll.js",
>    },
>```
> ê³„ì† ê¹Œë¨¹ì–´ì„œ ì™œ ì•ˆë˜ëŠ” ë°©í™©í–ˆìŒ

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

ê²ªì—ˆë˜ ì˜¤ë¥˜     
## ğŸŒŸ regeneratorRuntime error
---
### ğŸš” ë¬¸ì œ ë°œê²¬
---
```js
const loadItem = async () => {
    // ë°±ì—”ë“œì— ë‹¤ìŒ í˜ì´ì§€ë¥¼ ìš”êµ¬í•˜ëŠ” post reqë¥¼ ë³´ëƒ„
    const response = await fetch('/api/pages', {
        ...
    });
```
![1-1](/assets/img/web/2021-09-07/1-2.png)         
loadItemì„ async/await ë°©ë²•ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ë ¤í•˜ì regeneratorRuntime errorê°€ ë°œìƒí•¨      
<br/>

### ğŸ” í•´ê²° ë°©ë²•
ì´ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œëŠ” **babel-polyfill**ë¥¼ ì„¤ì¹˜í•´ì¤˜ì•¼í•œë‹¤.        
```
npm install --save @babel/polyfill
```
ê·¸ë¦¬ê³  ìœ„ì¹˜ëŠ” í•´ë‹¹ js íŒŒì¼ì˜ ì œì¼ ìœ„ì—          
```js
require("babel-polyfill");
```
babel-polyfillì„ require í•´ì¤€ë‹¤.        

## ğŸŒŸ jsonë¥¼ ì½ì–´ì˜¤ì§€ ëª»í•˜ëŠ” ë¬¸ì œ
---
### ğŸš” ë¬¸ì œ ë°œê²¬
---
```js
const loadItem = async () => {
     // ë°±ì—”ë“œì— ë‹¤ìŒ í˜ì´ì§€ë¥¼ ìš”êµ¬í•˜ëŠ” post reqë¥¼ ë³´ëƒ„
     const response = await fetch('/api/pages', {
         method: "POST",
         headers: {
             "Content-Type": "application/json",
         },
         body: JSON.stringify({ pageCounter }),
     });
```         
ìœ„ì˜ ì½”ë“œì—ì„œ ë°±ì—”ë“œë¡œ JSON ë°ì´í„°ë¥¼ ë³´ë‚´ì£¼ì—ˆì§€ë§Œ ë°±ì—”ë“œì—ì„œ jsonë°ì´í„°ë¥¼ í•´ì„í•˜ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆë‹¤.        

### ğŸ” í•´ê²° ë°©ë²•
---
ğŸ—‚ src/server.js
```js
app.use(express.json());
```
expressì˜ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•´ì„œ ê°„ë‹¨íˆ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤.        
ìœ„ì˜ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ê¸°ë§Œ í•˜ë©´ ë°±ì—”ë“œì—ì„œ jsonì„ í•´ì„í•  ìˆ˜ ìˆê²Œëœë‹¤.     

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ MongoDBì˜ populateë¥¼ í•œ ë‹¤ìŒ limitë¥¼ ì ìš©í•˜ê¸°
---
homeì—ì„œ ëª¨ë“  ë‹¨ì–´ë¥¼ ë°›ì•„ì˜¬ ë•ŒëŠ” populateë¥¼ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ì—ˆì§€ë§Œ userê°€ ê°€ì§€ê³  ìˆëŠ” ë‹¨ì–´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ì„œëŠ” populateê°€ í•„ìš”í–ˆê³  ì´ë–„ëŠ” limitë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì´ ì¢€ ë‹¬ëë‹¤.        
<br/>

homeì—ì„œ limitë¥¼ ì“¸ ë•Œ
```js
export const loadPages = async (req, res) => {
    const { body: { pageCounter } } = req;
    const words = await Word.find({}).sort({ createdAt: "desc" }).limit(10).skip((pageCounter - 1) * 10);
    if (words.length === 0) {
        return res.sendStatus(404);
    }
    return res.status(201).json({ words });
}
```

mypageì—ì„œ limitë¥¼ ì“¸ ë•Œ
```js
export const mypageLoading = async (req, res) => {
    const { body: { pageCounter } } = req;
    const { id } = req.params;
    const wordsData = await User.findById(id).populate({ // populateë¥¼ ì‚¬ìš©
        path: "words", // ê°€ì ¸ì˜¬ model
        options: {
            sort: {
                createdAt: "desc"
            },
            limit: 10,
            skip: (pageCounter - 1) * 10,
        }
    });
    if (wordsData.words.length === 0) {
        return res.sendStatus(404);
    }
    return res.status(201).json({ words: wordsData.words });
}
```
<https://stackoverflow.com/questions/32207457/node-js-mongoose-populate-limit>      
ì´ ê¸€ì„ ì°¸ê³ í•´ì„œ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤.      


## ğŸŒŸ í”„ë¡ íŠ¸ì—ì„œ idë¥¼ ê°€ì ¸ì˜¤ê¸°  
---
ë§ˆì°¬ê°€ì§€ë¡œ homeì—ì„œ id ì—†ì´ ëª¨ë“  wordsë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆì—ˆì§€ë§Œ userê°€ ê°€ì§„ wordsë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ì„œëŠ” idê°€ í•„ìš”í–ˆê³  í”„ë¡ íŠ¸ì—ì„œ ë°±ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸¸ ì›í•˜ëŠ” userë¥¼ ì•Œë ¤ì¤„ í•„ìš”ê°€ ìˆì—ˆë‹¤.      
![1-1](/assets/img/web/2021-09-07/1-3.png)         
ì´ ë•Œ ì£¼ëª©í•œ ê²ƒì´ url ì†ì— ìˆëŠ” userì˜ idì˜€ê³  ì´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ì„œ ë˜ ê²€ìƒ‰ì„ í–ˆë‹¤...        
<https://stackoverflow.com/questions/979975/how-to-get-the-value-from-the-get-parameters>       
ì—¬ê¸°ì„œ ì°¾ì„ ìˆ˜ ìˆì—ˆë‹¤.      
<br/>

ğŸ—‚ src/client/js/infiniteScrollMyPage.js        
```js
const loadItem = async () => {
    const url_string = window.location.href;
    const id = url_string.split('users/')[1];
    try {
        const response = await fetch(`/api/${id}/myPages`, {
            method: "POST",
             headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ pageCounter }),
        });
```        
window.location.href; ì´ë¼ëŠ” ì½”ë“œë¥¼ ì¨ì„œ ì£¼ì†Œë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì²˜ìŒ ì•Œì•˜ë‹¤.      
ê·¸ë¦¬ê³  ì´ë¥¼ users/ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°˜ìœ¼ë¡œ ì˜ë¼ì„œ ë’·ë¶€ë¶„ì˜ user idë¥¼ fetchì— ë„£ì–´ì„œ ë°±ì—”ë“œë¡œ ì „ì†¡í–ˆë”ë‹ˆ ë‹¤ìŒ í˜ì´ì§€ì˜ ê°’ì„ ì˜ ë¶ˆëŸ¬ì˜¤ê²Œ ë˜ì—ˆë‹¤.        