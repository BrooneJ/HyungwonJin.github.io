---
layout: post
title: "210827-TIL(Redux-saga)"
subtitle: "TIL-210827"
categories: til
tags: til
comments: false
---

# ğŸ“ ê³µë¶€í•  ê±°ë¦¬
---
- unshift     
    ```javascript
    const array1 = [1, 2, 3];

    console.log(array1.unshift(4, 5));
    // expected output: 5

    console.log(array1);
    // expected output: Array [4, 5, 1, 2, 3]
    ```
- immer ì‚¬ìš©ë²•

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ comment ì…ë ¥í•˜ë©´ ì‘ë™í•˜ëŠ” ê³¼ì •
---
1. components/CommentForm.jsì—ì„œ comment ì‘ì„±í•´ì„œ onSubmití•˜ë©´      
```javascript
const CommentForm = ({ post }) => {
    const id = useSelector((state) => state.user.me?.id);
    const [commentText, onChangeCommentText, setCommentText] = useInput('');

    const onSubmitComment = useCallback(() => {
        dispatch({
            type: ADD_COMMENT_REQUEST,
            data: { content: commentText, postId: post.id, userId: id }
        });
    }, [commentText, id]);

    return (
        <Form onFinish={onSubmitComment}>
            <Form.Item style={{ position: 'relative', margin: 0 }}>
                <Input.TextArea value={commentText} onChange={onChangeCommentText} rows={4} />
                <Button
->                  style={{ position: 'absolute', right: 0, bottom: -40, zIndex: 1 }} // zIndex ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— ì˜¬ë¼ê°€ë„ë¡
                    type="primary"
                    htmlType="submit"
                    loading={addCommentLoading}
->              >ì‚ì•½</Button>
            </Form.Item>
        </Form>
    )
}
```
dataì— { content: commentText, postId: post.id, userId: id } ì´ ê°ì²´ ë°ì´í„°ê°€ ë“¤ì–´ê°„ë‹¤.    
>post => propsë¡œë¶€í„° ë°›ìŒ        
id => useSelectorë¡œ reduxì—ì„œ ê°€ì ¸ì˜´      
commentText => component stateì— ìˆìŒ       

ì´ë¥¼ dispatchí•´ì„œ ADD_COMMENT_REQUESTì— ì˜¬ë¦°ë‹¤.     

2. ì˜¬ë¼ì˜¨ ë°ì´í„°ë¥¼ sagaê°€ ë°›ëŠ”ë‹¤.       
sagas/post.js       
```javascript
function* addComment(action) { // (2)ì—¬ê¸°ì„œ ì‹¤í–‰í•œë‹¤.
    try {
        // const result = yield call(addCommentAPI, action.data);
        yield delay(1000);
        yield put({
            type: ADD_COMMENT_SUCCESS, // ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ìœ¼ë©´ ADD_COMMENT_SUCCESSë¥¼ ë³´ëƒ„
            data: action.data, // ì¸ìˆ˜ë¥¼ ì—¬ê¸°ì„œ ë°›ìŒ
        })
    } catch (err) {
        yield put({
            type: ADD_COMMENT_FAILURE,
            data: err.response.data,
        })
    }
}

function* watchAddComment() {
    yield takeLatest(ADD_COMMENT_REQUEST, addComment);
} // (1) ì—¬ê¸°ì„œ ADD_COMMENT_REQUESTì— ì˜¬ë¼ì˜¨ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ
```
ì •ìƒì ìœ¼ë¡œ ADD_COMMENT_REQUESTê°€ ì‹¤í–‰ ëìœ¼ë©´ ADD_COMMENT_SUCCESS actionì„ ë³´ë‚¸ë‹¤.       

3. ADD_COMMENT_SUCCESSë¥¼ reducerì—ì„œ í™•ì¸í•œë‹¤.      
reducers/post.js        
```javascript
const reducer = (state = initialState, action) => {
    switch (action.type) {
        ...
        case ADD_COMMENT_SUCCESS: {
            const postIndex = state.mainPosts.findIndex((v) => v.id === action.data.postId);
            const post = { ...state.mainPosts[postIndex] };
            post.Comments = [dummyComment(action.data.content), ...post.Comments];
            const mainPosts = [...state.mainPosts];
            mainPosts[postIndex] = post;
            return {
                ...state,
                mainPosts,
                addCommentLoading: false,
                addCommentDone: true,
            }
        }
        ...
}
```

- ëŒ“ê¸€ ì •ë³´ë¥¼ ì°¾ëŠ” ìˆœì„œ       
```javascript
export const initialState = {
    mainPosts: [{
        id: 1,
        ...
        Comments: [...]
    }],
    ...
}
```
ê²Œì‹œê¸€ì˜ idë¥¼ ì°¾ê³  ê·¸ ì†ì—ì„œ Commentsì— ì ‘ê·¼í•œë‹¤.

â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ postë¥¼ ì‚­ì œí•˜ëŠ” ë°©ë²•
---
ê²Œì‹œë¬¼ ì† 'ì‚­ì œ' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì•„ë˜ ì½”ë“œì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë™ì‘ì´ ì¼ì–´ë‚œë‹¤.     

components/PostCard.js      
```javascript
import { REMOVE_POST_REQUEST } from '../reducers/post';

const PostCard = ({ post }) => {
    const dispatch = useDispatch();
    const { removePostLoading } = useSelector((state) => state.post);

    const onRemovePost = useCallback(() => { // (2) dispatchê°€ ë™ì‘í•˜ë©´ì„œ
        dispatch({
            type: REMOVE_POST_REQUEST, // REMOVE_POST_REQUEST ì•¡ì…˜ì„ ë³´ëƒ„
            data: post.id, // propsë¡œ ë°›ì€ post.id ë°ì´í„°ë„ ì˜¬ë¦¼
        })
    }, []);
    ...
    return (
        <div style={{ marginBottom: 20 }}>
            <Card            
                actions={[
                    ...
                        <Button.Group>
                            {id && post.User.id === id ? (
                                <>
                                    <Button>ìˆ˜ì •</Button>
->                                  <Button type="danger" 
                                            loading={removePostLoading} 
                                            onClick={onRemovePost}
                                            >ì‚­ì œ</Button>
                                    //removePostLoadingì´ ì™„ë£Œë  ë•Œê¹Œì§€ ë¡œë”©í™”ë©´ì´ ë‚˜íƒ€ë‚¨
                                    // (1) ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ onRemovePost í•¨ìˆ˜ê°€ ì‘ë™
                                </>
                            ) : <Button>ì‹ ê³ </Button>}
                        </Button.Group>
                ]}
                >
```
1. onClickì˜ onRemovePost í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë©° REMOVE_POST_REQUEST ì•¡ì…˜ì´ dispatch ë˜ê³  post.idê°€ ì˜¬ë¼ê°€ê²Œ ëœë‹¤.

2. reducers/post.jsì™€ sagas/post.jsì— dispatchëœ REMOVE_POST_REQUEST ì•¡ì…˜ì´ ì „ë‹¬ë˜ì–´ í•´ë‹¹ ê¸°ëŠ¥ì´ ì‹¤í–‰ëœë‹¤.      
reducers/post.js
```javascript
const reducer = (state = initialState, action) => {
    switch (action.type) {
        ...
        case REMOVE_POST_REQUEST:
            return {
                ...state,
                removePostLoading: true,
                removePostDone: false,
                removePostError: null,
            }
        ...
    }
}
```
REMOVE_POST_REQUESTë¥¼ ë°›ìœ¼ë©´ return ì•ˆì˜ ì‚¬í•­ì„ ì‹¤í–‰í•¨      

sagas/post.js       
```javascript
function* removePost(action) {
    try {
        // const result = yield call(removePostAPI, action.data);
        yield delay(1000);
        yield put({ // post reducer ì¡°ì‘
            type: REMOVE_POST_SUCCESS,
            data: action.data, // action.dataì— ì–´ë–¤ ê²Œì‹œë¬¼ì„ ì§€ì› ëŠ”ì§€ idê°€ ë“¤ì–´ìˆìŒ
        });
        // í•œë²ˆì— userì™€ postë¥¼ ì¡°ì‘í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ actionì„ ë‘ê°€ì§€ë¡œ ë‚˜ëˆ ì„œ ì§„í–‰í•œë‹¤.
        yield put({ // user reducer ì¡°ì‘ 
            type: REMOVE_POST_OF_ME,
            data: action.data,
        })
    } catch (err) {
        yield put({
            type: REMOVE_POST_FAILURE,
            data: err.response.data,
        })
    }
}

function* watchRemovePost() {
    yield takeLatest(REMOVE_POST_REQUEST, removePost);
} // (1) ì—¬ê¸°ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ê°™ì´ actionì´ ë“¤ì–´ì˜¤ë©´ ë™ì‘í•¨
```
sagaì—ì„œ REMOVE_POST_REQUEST actionì„ ë°›ì•„ì„œ removePost ì œë„¤ë ˆì´í„°ë¥¼ ì‹¤í–‰í•œë‹¤.      
ì´ë•Œ REMOVE_POST_SUCCESSì™€ REMOVE_POST_OF_MEë¥¼ í•œë²ˆì— ì˜¬ë¦´ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ë”°ë¡œ ë‚˜ëˆ ì„œ ì‘ì„±í•´ì¤€ë‹¤.
REMOVE_POST_SUCCESS => ì‚­ì œê°€ ì˜¬ë°”ë¥´ê²Œ ìˆ˜í–‰ë¨       
REMOVE_POST_OF_ME => ìœ ì € ë°ì´í„°ì—ì„œ ê²Œì‹œë¬¼ ê¸°ë¡ì„ ì‚­ì œí•¨       

3. REMOVE_POST_SUCCESSë¥¼ reducerì—ì„œ ë°›ìœ¼ë©´ ì°¾ì•„ì„œ ì§€ì›Œì¤Œ
```javascript
case REMOVE_POST_SUCCESS:
    return {
        ...state,
        // ì¶”ê°€ ë˜ëŠ” ê²Œì‹œë¬¼ì„ ì•ì— ì…ë ¥í•´ì•¼ ìµœìƒë‹¨ì— ìœ„ì¹˜í•¨
        mainPosts: state.mainPosts.filter((v) => v.id !== action.data),
        removePostLoading: false,
        removePostDone: true,
    }
```            
filterë¥¼ í†µí•´ì„œ ì‚­ì œí•¨      



â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

## ğŸŒŸ immer ë¼ì´ë¸ŒëŸ¬ë¦¬
---
ë¶ˆë³€ì„±ì„ ì§€í‚¤ëŠ”ë° ë³µì¡í•œ ì½”ë“œë¥¼ ì“°ëŠ”ê±¸ ë§‰ì•„ì¤Œ       
```
npm i immer
```
reducers/post.js        
```javascript
import produce from "immer";
...
const reducer = (state = initialState, action) => {
    return produce(state, (draft) => { // ì´ ë¶€ë¶„ì„ ë„£ì–´ì¤˜ì„œ stateë¥¼ draftë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œëœë‹¤.
        // ì¦‰ prevState ëŒ€ì‹ ì— draftë¥¼ ì‚¬ìš©í•´ì„œ ë¶ˆë³€ì„ ì„ ìœ ì§€í•  ìˆ˜ ìˆê²Œ ëœë‹¤.
        switch (action.type) {
            case ADD_POST_REQUEST:
                    draft.addPostLoading = true; // spreadë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì“¸ ìˆ˜ ìˆê²Œ ë¨
                    draft.addPostDone = false;
                    draft.addPostError = null;
                    break;
                // return {
                //     ...state,
                //     addPostLoading: true,
                //     addPostDone: false,
                //     addPostError: null,
                // }
        }
    }
    })
```
ì´ë ‡ê²Œ ë³´ë©´ í¬ê²Œ ë³€í•œ ê²ƒì´ ì—†ê²Œ ë³´ì´ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì—ì„œëŠ” ì½”ë“œ ì¤„ì„ í¬ê²Œ ì¤„ì¼ ìˆ˜ ìˆë‹¤.        
```javascript
case ADD_COMMENT_SUCCESS: {
    const post = draft.mainPosts.find((v) => v.id === action.data.postId);// ì›í•˜ëŠ” postë¥¼ ì°¾ì•„ì„œ
    post.Comments.unshift(dummyComment(action.data.content)); // ì œì¼ ì•ì— ê²Œì‹œê¸€ì„ ì¶”ê°€
    draft.addCommentLoading = false;
    draft.addCommentDone = true;
    break;
    // const postIndex = state.mainPosts.findIndex((v) => v.id === action.data.postId);
    // const post = { ...state.mainPosts[postIndex] };
    // post.Comments = [dummyComment(action.data.content), ...post.Comments];
    // const mainPosts = [...state.mainPosts];
    // mainPosts[postIndex] = post;
    // return {
    //     ...state,
    //     mainPosts,
    //     addCommentLoading: false,
    //     addCommentDone: true,
    // }
}
```
ì›í•˜ëŠ” í¬ìŠ¤í„°ì˜ idë¥¼ ì°¾ì•„ì„œ unshiftë¥¼ ì‚¬ìš©í•´ì„œ ìƒˆë¡œìš´ ê²Œì‹œë¬¼ì„ ì œì¼ ì•ìª½ì— ì¶”ê°€í•´ì£¼ê¸°ë§Œ í•˜ë©´ ëœë‹¤.      
â›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°ğŸ”ğŸ—»ğŸŒ‹ğŸâ›°      
<br/>

